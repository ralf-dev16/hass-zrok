name: Builder

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  init:
    runs-on: ubuntu-latest
    name: Initialize build
    outputs:
      architectures: ${{ steps.info.outputs.architectures }}
      version: ${{ steps.info.outputs.version }}
      name: ${{ steps.info.outputs.name }}
      slug: ${{ steps.info.outputs.slug }}
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Get add-on information
        id: info
        run: |
          # Read config.yaml and extract information
          if [ -f "zrok-share/config.yaml" ]; then
            VERSION=$(grep "^version:" zrok-share/config.yaml | awk '{print $2}' | tr -d '"')
            NAME=$(grep "^name:" zrok-share/config.yaml | sed 's/^name: *//' | tr -d '"')
            SLUG=$(grep "^slug:" zrok-share/config.yaml | awk '{print $2}' | tr -d '"')

            # Extract architectures
            ARCHITECTURES=$(grep -A 10 "^arch:" zrok-share/config.yaml | grep "  -" | awk '{print $2}' | tr '\n' ',' | sed 's/,$//')

            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "name=$NAME" >> $GITHUB_OUTPUT
            echo "slug=$SLUG" >> $GITHUB_OUTPUT
            echo "architectures=$ARCHITECTURES" >> $GITHUB_OUTPUT

            echo "Add-on: $NAME"
            echo "Version: $VERSION"
            echo "Slug: $SLUG"
            echo "Architectures: $ARCHITECTURES"
          else
            echo "Error: config.yaml not found"
            exit 1
          fi

  build:
    needs: init
    runs-on: ubuntu-latest
    name: Build ${{ matrix.arch }}
    strategy:
      matrix:
        arch: [amd64, aarch64, armv7]
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get build arguments
        id: build_args
        run: |
          # Read build.json to get base image
          if [ -f "zrok-share/build.json" ]; then
            BUILD_FROM=$(jq -r ".build_from.${{ matrix.arch }}" zrok-share/build.json)
            echo "build_from=$BUILD_FROM" >> $GITHUB_OUTPUT
            echo "Building from: $BUILD_FROM"
          else
            echo "Error: build.json not found"
            exit 1
          fi

      - name: Build add-on
        uses: docker/build-push-action@v5
        with:
          context: ./zrok-share
          platforms: linux/${{ matrix.arch == 'amd64' && 'amd64' || matrix.arch == 'aarch64' && 'arm64' || 'arm/v7' }}
          build-args: |
            BUILD_FROM=${{ steps.build_args.outputs.build_from }}
            BUILD_ARCH=${{ matrix.arch }}
            BUILD_VERSION=${{ needs.init.outputs.version }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/hass-zrok-${{ matrix.arch }}:${{ needs.init.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/hass-zrok-${{ matrix.arch }}:latest
          cache-from: type=gha,scope=${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ matrix.arch }}

      - name: Test image
        run: |
          echo "Testing ${{ matrix.arch }} image..."
          # Basic smoke test - verify the image was built
          docker images | grep hass-zrok || true

  publish:
    needs: [init, build]
    runs-on: ubuntu-latest
    name: Publish multi-arch manifest
    if: github.event_name != 'pull_request'
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          # Create multi-arch manifest for version tag
          docker manifest create \
            ghcr.io/${{ github.repository_owner }}/hass-zrok:${{ needs.init.outputs.version }} \
            ghcr.io/${{ github.repository_owner }}/hass-zrok-amd64:${{ needs.init.outputs.version }} \
            ghcr.io/${{ github.repository_owner }}/hass-zrok-aarch64:${{ needs.init.outputs.version }} \
            ghcr.io/${{ github.repository_owner }}/hass-zrok-armv7:${{ needs.init.outputs.version }}

          docker manifest push ghcr.io/${{ github.repository_owner }}/hass-zrok:${{ needs.init.outputs.version }}

          # Create multi-arch manifest for latest tag
          docker manifest create \
            ghcr.io/${{ github.repository_owner }}/hass-zrok:latest \
            ghcr.io/${{ github.repository_owner }}/hass-zrok-amd64:latest \
            ghcr.io/${{ github.repository_owner }}/hass-zrok-aarch64:latest \
            ghcr.io/${{ github.repository_owner }}/hass-zrok-armv7:latest

          docker manifest push ghcr.io/${{ github.repository_owner }}/hass-zrok:latest

  notify:
    needs: [init, build, publish]
    runs-on: ubuntu-latest
    name: Notify build complete
    if: github.event_name != 'pull_request'
    steps:
      - name: Build summary
        run: |
          echo "âœ… Build completed successfully!"
          echo "Add-on: ${{ needs.init.outputs.name }}"
          echo "Version: ${{ needs.init.outputs.version }}"
          echo "Architectures: ${{ needs.init.outputs.architectures }}"
          echo ""
          echo "Images published to:"
          echo "ghcr.io/${{ github.repository_owner }}/hass-zrok:${{ needs.init.outputs.version }}"
          echo "ghcr.io/${{ github.repository_owner }}/hass-zrok:latest"
